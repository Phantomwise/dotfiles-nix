#!/usr/bin/env bash

# AI Disclaimer:
# This script was generated by AI.
# Support all Matroska formats recognized by mkvmerge (from MKVToolNix):
# - .mkv (Matroska video)
# - .mka (Matroska audio)
# - .mks (Matroska subtitles)
# - .mk3d (Matroska 3D)
# - .webm (WebM, a Matroska-based format for web video/audio)

count=0
while IFS= read -r -d '' f; do
  # Remove the leading ./ if present (since find outputs relative paths)
  f="${f#./}"
  truncated_f="${f:0:50}"
  [ ${#f} -gt 50 ] && truncated_f="${truncated_f}..."
  info=$(mkvmerge -J "$f" | jq -r '.tracks | map(if .type == "video" then "\u001b[36m\(.id)\u001b[0m: \u001b[36m\(.type)\u001b[0m: language=\u001b[34m\(.properties.language // "none")\u001b[0m language_ietf=\u001b[35m\(.properties.language_ietf // "none")\u001b[0m" else "\u001b[36m\(.id)\u001b[0m: \u001b[36m\(.type)\u001b[0m: language=\u001b[34m\(.properties.language // "none")\u001b[0m language_ietf=\u001b[35m\(.properties.language_ietf // "none")\u001b[0m" end) | join("\t")')
  echo -e "$info\t$truncated_f"
  count=$((count + 1))
done < <(find . -maxdepth 1 \( -name "*.mkv" -o -name "*.mka" -o -name "*.mks" -o -name "*.mk3d" -o -name "*.webm" \) -print0)
echo "Total items: $count"
